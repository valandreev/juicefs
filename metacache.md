–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è. –¢—ã, –ø–æ —Å—É—Ç–∏, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —Å–¥–µ–ª–∞—Ç—å `rueidis.go` "–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º" (router), –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ª–∏–±–æ –≤ —Ä–µ–∂–∏–º–µ "–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏" (—Ç–µ–∫—É—â–µ–µ), –ª–∏–±–æ –≤ —Ä–µ–∂–∏–º–µ "–ª–æ–∫–∞–ª—å–Ω—ã–π write-back" (`fast-meta`).

–≠—Ç–æ —Å–∞–º—ã–π —á–∏—Å—Ç—ã–π –ø–æ–¥—Ö–æ–¥. –û–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å—é —Ç–≤–æ—é —Ä–∞–±–æ—Ç—É –ø–æ `rueidis` (–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è, –ø–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞) –∏ —Ä–∞—Å—à–∏—Ä—è–µ—Ç –µ–µ.

–í–æ—Ç –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, —É—á–∏—Ç—ã–≤–∞—é—â–∏–π –≤—Å–µ –Ω–∞—à–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è:

-----

### üèõÔ∏è –§–∞–∑–∞ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è BadgerDB

–¶–µ–ª—å: "–ù–∞—É—á–∏—Ç—å" `rueidis.go` —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–≤—É–º—è —Ä–µ–∂–∏–º–∞–º–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å BadgerDB.

  * **–®–∞–≥ 1: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `rueidisMeta` (–≤ `rueidis.go`)**
      * –î–æ–±–∞–≤—å –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É `rueidisMeta` –¥–≤–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª—è:
        ```go
        type rueidisMeta struct {
            *redisMeta
            // ... (–≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è) ...
            
            fastMetaEnabled bool      // –§–ª–∞–≥, —á—Ç–æ ?fast-meta=1 –≤–∫–ª—é—á–µ–Ω
            localCache      tkvClient // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ BadgerDB
            oplogQueue      chan *metaOplog // –û—á–µ—Ä–µ–¥—å "–≥—Ä—è–∑–Ω—ã—Ö" —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        }
        ```
  * **–®–∞–≥ 2: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `newRueidisMeta` (–≤ `rueidis.go`)**
      * –î–æ–±–∞–≤—å –ø–∞—Ä—Å–∏–Ω–≥ `?fast-meta=1` –∏–∑ URI (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ç–æ–º—É, –∫–∞–∫ —Ç—ã –ø–∞—Ä—Å–∏—à—å `?ttl=`, —Å—Ç—Ä–æ–∫–∞ 149). –°–æ—Ö—Ä–∞–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ `m.fastMetaEnabled`.
      * **–ï—Å–ª–∏ `m.fastMetaEnabled == true`:**
        1.  **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `localCache`:**
              * –ü–æ–ª—É—á–∏ –ø—É—Ç—å –∫ –∫—ç—à—É –¥–∞–Ω–Ω—ã—Ö: `conf.CacheDir`.
              * –°–æ–∑–¥–∞–π –ø—É—Ç—å –¥–ª—è –∫—ç—à–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: `localPath := filepath.Join(conf.CacheDir, "meta")`.
              * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π Badger: `m.localCache, err = newTkvClient("badger", localPath)`.
        2.  **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –û—á–µ—Ä–µ–¥–∏:** `m.oplogQueue = make(chan *metaOplog, 1024)` (—Ä–∞–∑–º–µ—Ä –ø–æ–¥–±–µ—Ä–µ—à—å).
        3.  **–ó–∞–ø—É—Å–∫ `syncWorker`:** `go m.runSyncWorker()` (—ç—Ç–æ—Ç –≤–æ—Ä–∫–µ—Ä –º—ã –Ω–∞–ø–∏—à–µ–º –≤ –§–∞–∑–µ 4).
  * **–®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 1**
      * –ó–∞–ø—É—Å—Ç–∏ `juicefs mount` —Å `rueidis://...` -\> –£–±–µ–¥–∏—Å—å, —á—Ç–æ `m.localCache == nil`.
      * –ó–∞–ø—É—Å—Ç–∏ `juicefs mount` —Å `rueidis://...?fast-meta=1` -\> –£–±–µ–¥–∏—Å—å, —á—Ç–æ `m.localCache != nil` –∏ –ø–∞–ø–∫–∞ `/meta` —Å–æ–∑–¥–∞–Ω–∞ –≤ `CacheDir`.

-----

### üìñ –§–∞–∑–∞ 2: –õ–æ–≥–∏–∫–∞ –ß—Ç–µ–Ω–∏—è (Read-Through Cache) –∏ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è

–¶–µ–ª—å: –ó–∞—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ Badger, –∏—Å–ø–æ–ª—å–∑—É—è Redis –∫–∞–∫ –±—ç–∫–µ–Ω–¥, –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à.

  * **–®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ `CLIENT TRACKING`**

      * –í `newRueidisMeta`, –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ `rueidis.ClientOption` (—Å—Ç—Ä–æ–∫–∞ 413):
      * **–ï—Å–ª–∏ `m.fastMetaEnabled == true`:**
        1.  **–û–ø—Ä–µ–¥–µ–ª–∏ –∫–æ–ª–ª–±—ç–∫ `OnInvalidation`:**
            ```go
            invalidationCallback := func(messages []rueidis.RedisMessage) {
                keys := parseKeysFromMsg(messages) // (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞)
                if len(keys) > 0 {
                    // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º –∏–∑ Badger, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç—å
                    go m.localCache.txn(context.Background(), func(tx *kvTxn) error {
                        for _, key := range keys {
                            tx.delete(key)
                        }
                        return nil
                    })
                }
            }
            ```
        2.  –£—Å—Ç–∞–Ω–æ–≤–∏ –æ–ø—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞:
              * `opt.OnInvalidation = invalidationCallback` (–ø–µ—Ä–µ–¥–∞–µ–º –Ω–∞—à –∫–æ–ª–ª–±—ç–∫).
              * `opt.DisableCache = true` (**–í–∞–∂–Ω–æ\!** –û—Ç–∫–ª—é—á–∞–µ–º *–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π* –∫—ç—à `rueidis` –≤ –ø–∞–º—è—Ç–∏, —Ç.–∫. —É –Ω–∞—Å —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å Badger).

  * **–®–∞–≥ 5: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ß–¢–ï–ù–ò–Ø**

      * –¢–µ–±–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å **–≤—Å–µ** —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —á–∏—Ç–∞—é—Ç –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `doGetAttr`, `doLookup`, `doRead`, `GetXattr`, `doReaddir` –∏ —Ç.–¥.).
      * –ö–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–∞":
        ```go
        func (m *rueidisMeta) doGetAttr(ctx Context, inode Ino, attr *Attr) syscall.Errno {
            if !m.fastMetaEnabled {
                // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–∫–∞–∫ —Å–µ–π—á–∞—Å –≤ rueidis.go)
                return m.redisMeta.doGetAttr(ctx, inode, attr)
            }

            // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ ?fast-meta=1:
            // 1. –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ Badger
            key := m.inodeKey(inode)
            err := m.localCache.simpleTxn(ctx, func(tx *kvTxn) error {
                data := tx.get(key)
                if data == nil { return syscall.ENOENT } // cache miss
                m.parseAttr(data, attr)
                return nil
            }, 0)
            
            if err == nil { return 0 } // –ù–∞—à–ª–∏ –≤ Badger, —É—Å–ø–µ—Ö!

            // 2. Cache Miss: —á–∏—Ç–∞–µ–º –∏–∑ Redis
            data, err := m.compat.Get(ctx, key).Bytes() // m.compat - —ç—Ç–æ rueidis
            if err != nil { return errno(err) }

            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Badger
            m.localCache.txn(ctx, func(tx *kvTxn) error {
                tx.set(key, data)
                return nil
            })
            
            m.parseAttr(data, attr)
            return 0
        }
        ```

  * **–®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 2**

      * –ó–∞–ø—É—Å—Ç–∏ 2 –∫–ª–∏–µ–Ω—Ç–∞ (–ê –∏ –ë) —Å `?fast-meta=1`.
      * –ö–ª–∏–µ–Ω—Ç –ê: `ls /` (–∫—ç—à Badger –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è).
      * –ö–ª–∏–µ–Ω—Ç –ë: `mkdir /newdir`.
      * –ö–ª–∏–µ–Ω—Ç –ê: `ls /` (–¥–æ–ª–∂–µ–Ω *–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ* —É–≤–∏–¥–µ—Ç—å `newdir`, —Ç.–∫. –∫–æ–ª–ª–±—ç–∫ `OnInvalidation` –æ—á–∏—Å—Ç–∏–ª —Å—Ç–∞—Ä—ã–π –∫—ç—à `ls`).

-----

### ‚ö° –§–∞–∑–∞ 3: –õ–æ–≥–∏–∫–∞ –ó–∞–ø–∏—Å–∏ (Write-Back Cache)

–¶–µ–ª—å: –ó–∞—Å—Ç–∞–≤–∏—Ç—å `create`, `rename`, `unlink` –æ—Ç–≤–µ—á–∞—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.

  * **–®–∞–≥ 7: –°–æ–∑–¥–∞–Ω–∏–µ `oplog` –∏ `recordingTxn`**

      * –û–ø—Ä–µ–¥–µ–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `metaOp` (`{op, key, value, delta}`) –∏ `metaOplog` (`[]*metaOp`).
      * –°–æ–∑–¥–∞–π –æ–±–µ—Ä—Ç–∫—É `recordingTxn` (–¥–ª—è `kvtxn`), –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `set/delete/incrBy` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
        1.  –í—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º `localTxn` (Badger).
        2.  –î–æ–±–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –≤ —Å—Ä–µ–∑ `ops` (`metaOplog`).

  * **–®–∞–≥ 8: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `rueidisMeta.txn()` (–ì–ª–∞–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏)**

      * –ü–µ—Ä–µ–ø–∏—à–∏ `rueidisMeta.txn` –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ:
        ```go
        func (m *rueidisMeta) txn(ctx Context, txf func(tx rueidiscompat.Tx) error, keys ...string) error {
            if !m.fastMetaEnabled {
                // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞: —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π WATCH/MULTI/EXEC –≤ Redis
                return m.redisMeta.txn(ctx, txf, keys...)
            }

            // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ ?fast-meta=1:
            var oplog *metaOplog
            
            // 1. –í—ã–ø–æ–ª–Ω—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –õ–û–ö–ê–õ–¨–ù–û –≤ Badger
            err := m.localCache.txn(ctx, func(tx *kvTxn) error {
                // –°–æ–∑–¥–∞–µ–º "–∑–∞–ø–∏—Å—ã–≤–∞—é—â–∏–π" kvtxn
                recorder := &recordingTxn{localTxn: tx, ops: make(metaOplog, 0)}
                
                // –û–±–µ—Ä—Ç—ã–≤–∞–µ–º –µ–≥–æ –≤ kvTxn, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –≤ redisMeta-—Ñ—É–Ω–∫—Ü–∏–∏
                kvTxnWrapper := &kvTxn{kvtxn: recorder, retry: 0}

                // !!! –•–∞–∫: —Ç–≤–æ–∏ doMknod/doRename –∏ —Ç.–¥. –≤ redis.go 
                // –æ–∂–∏–¥–∞—é—Ç `rueidiscompat.Tx`. –ù–∞–º –Ω—É–∂–Ω–æ –∏—Ö –æ–±–º–∞–Ω—É—Ç—å
                // –∏–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –∏—Ö, —á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏–Ω–∏–º–∞–ª–∏ `kvtxn`.
                // –ü—Ä–æ—â–µ –≤—Å–µ–≥–æ –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É doMknod/doRename –∏ —Ç.–¥.
                // –∏–∑ redis.go –∏ –∑–∞—Å—Ç–∞–≤–∏—Ç—å –∏—Ö —Ä–∞–±–æ—Ç–∞—Ç—å —Å `kvTxnWrapper`.
                
                // –í–ú–ï–°–¢–û f(txf) –º—ã –¥–æ–ª–∂–Ω—ã –±—É–¥–µ–º –≤—ã–∑—ã–≤–∞—Ç—å –Ω–∞—à—É
                // –æ–±–µ—Ä—Ç–∫—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç txf —Å –ø–æ–¥–¥–µ–ª—å–Ω—ã–º Tx
                // ... (–≠—Ç–æ —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è "–≥—Ä—è–∑–Ω–∞—è" —á–∞—Å—Ç—å) ...
                
                // ---- –£–ü–†–û–©–ï–ù–ù–´–ô –í–ê–†–ò–ê–ù–¢ ----
                // –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –º—ã –ø–µ—Ä–µ–ø–∏—Å–∞–ª–∏/–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª–∏ `txf` 
                // —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª —Å –Ω–∞—à–∏–º `kvTxnWrapper`
                
                // err := txf(kvTxnWrapper) // (–≠—Ç–æ –ø—Å–µ–≤–¥–æ–∫–æ–¥)
                
                // ---- –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–ô –í–ê–†–ò–ê–ù–¢ ----
                // –§—É–Ω–∫—Ü–∏–∏ —Ç–∏–ø–∞ doMknod/doRename/doUnlink —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã 
                // –≤ `redisMeta` –∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç `rueidiscompat.Tx`.
                // –ú—ã –Ω–µ –º–æ–∂–µ–º –∏—Ö –≤—ã–∑–≤–∞—Ç—å.
                // –ù–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∏–∑ `redis.go`
                // –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `kvtxn` (–∫–∞–∫ –≤ `tkv.go`).
                // `m.txn` –≤ `tkv.go` (—Å—Ç—Ä–æ–∫–∞ 1046) - –∏–¥–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä.
                
                // ... (–í—ã–ø–æ–ª–Ω—è–µ–º txf, –∏—Å–ø–æ–ª—å–∑—É—è recorder)
                
                // 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º Oplog –≤ Badger –ê–¢–û–ú–ê–†–ù–û
                oplogKey := []byte(fmt.Sprintf("oplog:%d", time.Now().UnixNano()))
                serializedOps, _ := json.Marshal(recorder.ops)
                tx.set(oplogKey, serializedOps)
                
                // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º oplog –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –æ—á–µ—Ä–µ–¥—å
                oplog = &recorder.ops 
                return nil // –ö–æ–º–º–∏—Ç–∏–º Badger
            }, 0) // 0 —Ä–µ—Ç—Ä–∞–µ–≤, —Ç.–∫. —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ
            
            if err != nil {
                return err // –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞
            }

            // 8. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º oplog –≤ –æ—á–µ—Ä–µ–¥—å (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ)
            select {
            case m.oplogQueue <- oplog:
            default:
                logger.Warnf("Oplog queue is full! Write will be delayed.")
                // –í–æ—Ä–∫–µ—Ä –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –µ–≥–æ –∏–∑ Badger –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ,
                // –Ω–æ –º—ã –º–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å
            }
            
            // 9. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö
            return nil 
        }
        ```

  * **–®–∞–≥ 9: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 3**

      * `?fast-meta=1`: `time touch /mnt/jfs/testfile` –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.
      * –ü—Ä–æ–≤–µ—Ä—å Badger: —Ç–∞–º –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è `A:ino`, `D:parent/testfile` –∏ `oplog:<id>`.
      * `ls` –Ω–∞ *–¥—Ä—É–≥–æ–º* –∫–ª–∏–µ–Ω—Ç–µ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å `testfile` (–ø–æ–∫–∞).

-----

### üõ∞Ô∏è –§–∞–∑–∞ 4: –§–æ–Ω–æ–≤—ã–π –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä (`syncWorker`)

–¶–µ–ª—å: –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å `oplog` –∏–∑ Badger –≤ Redis –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

  * **–®–∞–≥ 10: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `runSyncWorker()`**

      * –≠—Ç–æ `for oplog := range m.oplogQueue { ... }`.
      * –í–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ –≤—ã–∑–æ–≤–∏ `m.syncOplog(oplog)`.

  * **–®–∞–≥ 11: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `syncOplog(oplog *metaOplog)`**

      * `keysToWatch := extractKeysFromOplog(oplog)`
      * `err := m.redisMeta.txn(ctx, func(tx rueidiscompat.Tx) error { ... }, keysToWatch...)`
          * –í–Ω—É—Ç—Ä–∏ `txn` –∏—Å–ø–æ–ª—å–∑—É–π `TxPipelined` –∏ –ø—Ä–∏–º–µ–Ω–∏ –≤—Å–µ `op` –∏–∑ `oplog` –≤ Redis (–∫–∞–∫ –≤ `rueidis_batch_write.go`).
      * **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–í–∞–∂–Ω–æ\!):**
          * **`if err == nil` (–£—Å–ø–µ—Ö):**
              * –£–¥–∞–ª–∏ `oplog:<id>` –∏–∑ Badger.
          * **`if err == rueidiscompat.TxFailedErr` (–ö–æ–Ω—Ñ–ª–∏–∫—Ç\!):**
              * **"–ñ–µ—Ä—Ç–≤—É–µ–º" –∑–∞–ø–∏—Å—å—é.**
              * Log `ERROR`: "–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è".
              * –ó–∞–ø—É—Å—Ç–∏ **–∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é** –≤ `m.localCache` (Badger), —á—Ç–æ–±—ã *—É–¥–∞–ª–∏—Ç—å* –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å–æ–∑–¥–∞–ª–∏ (`A:ino`, `D:parent/testfile`).
              * –£–¥–∞–ª–∏ `oplog:<id>` –∏–∑ Badger.
          * **`if err == network_error` (–°–µ—Ç—å —É–ø–∞–ª–∞):**
              * **–ù–µ** —É–¥–∞–ª—è–π `oplog`.
              * Log `WARN`: "–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–≤—Ç–æ—Ä –ø–æ–∑–∂–µ".
              * –ü–µ—Ä–µ–≤–µ–¥–∏ –§–° –≤ `ReadOnly` (—Å–º. –®–∞–≥ 14).
              * `requeue` (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ N —Å–µ–∫—É–Ω–¥).

  * **–®–∞–≥ 12: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 4**

      * `?fast-meta=1`: `touch file1`. –£–±–µ–¥–∏—Å—å, —á—Ç–æ `oplog` —É–¥–∞–ª–µ–Ω –∏–∑ Badger, –∞ `file1` –ø–æ—è–≤–∏–ª—Å—è –≤ Redis.
      * –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π "–∂–µ—Ä—Ç–≤—É" (–®–∞–≥ 19 –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –æ—Ç–≤–µ—Ç–∞).

-----

### üõ°Ô∏è –§–∞–∑–∞ 5: –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å (–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ "–û—Ç–ø—É—Å–∫")

–¶–µ–ª—å: –°–¥–µ–ª–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –Ω–∞–¥–µ–∂–Ω–æ–π.

  * **–®–∞–≥ 13: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (`flock`/`plock`)**

      * –ù–∞–π–¥–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `Getlk`, `Setlk`, `Setlkw` (–æ–Ω–∏ –≤ `pkg/meta/rueidis_lock.go`).
      * –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω–∏ **–Ω–µ** –∏—Å–ø–æ–ª—å–∑—É—é—Ç `m.localCache`.
      * –û–Ω–∏ *–≤—Å–µ–≥–¥–∞* –¥–æ–ª–∂–Ω—ã –≤—ã–∑—ã–≤–∞—Ç—å `m.redisMeta.Getlk/Setlk`, —á—Ç–æ–±—ã –∏–¥—Ç–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ Redis.

  * **–®–∞–≥ 14: Read-Only –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–≤—è–∑–∏**

      * –í `syncOplog` (–®–∞–≥ 11), –µ—Å–ª–∏ `err == network_error`:
        1.  –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–π `m.conf.SetReadOnly(true)` (—ç—Ç–æ –≤ `baseMeta`).
        2.  –í—Å–µ –Ω–æ–≤—ã–µ `create/rm/mv` –æ—Ç FUSE —Ç–µ–ø–µ—Ä—å –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å `EROFS`.
      * `syncWorker` –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø–æ–ø—ã—Ç–∫–∏ `syncOplog` –≤ —Ñ–æ–Ω–µ.
      * –ö–æ–≥–¥–∞ `syncOplog` *–Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ* –ø—Ä–æ–π–¥–µ—Ç (—Å–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞):
        1.  –ó–∞–ø—É—Å—Ç–∏ **–ø–æ–ª–Ω—É—é –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –∫—ç—à–∞ —á—Ç–µ–Ω–∏—è** (–®–∞–≥ 15), —Ç.–∫. –º—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ `CLIENT TRACKING`.
        2.  –ü–æ—Å–ª–µ *–∑–∞–ø—É—Å–∫–∞* –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏, `m.conf.SetReadOnly(false)`.

  * **–®–∞–≥ 15: Bootstrap (–ó–∞–ø—É—Å–∫ `mount` –ø–æ—Å–ª–µ "–æ—Ç–ø—É—Å–∫–∞")**

      * –í `newRueidisMeta`, –µ—Å–ª–∏ `m.fastMetaEnabled == true`:
      * –°—Ä–∞–∑—É –ø–æ—Å–ª–µ `go m.runSyncWorker()`, –∑–∞–ø—É—Å—Ç–∏ `go m.bootstrapFastMeta()`.
      * **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `bootstrapFastMeta()`:**
        1.  `m.conf.SetReadOnly(true)`.
        2.  **–ó–∞–¥–∞—á–∞ 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Oplog.**
              * –ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π `m.localCache` (Badger) –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É `oplog:*`.
              * –î–ª—è –∫–∞–∂–¥–æ–≥–æ `oplog`'–∞: `m.oplogQueue <- oplog`.
        3.  **–ó–∞–¥–∞—á–∞ 2: –ü–æ–ª–Ω–∞—è –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ö—ç—à–∞ –ß—Ç–µ–Ω–∏—è.**
              * –ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π `m.localCache` –ø–æ *–≤—Å–µ–º* –∫–ª—é—á–∞–º (–∫—Ä–æ–º–µ `oplog:*`).
              * –£–¥–∞–ª–∏ –∏—Ö *–≤—Å–µ—Ö* (–Ω–∞–ø—Ä–∏–º–µ—Ä, `tx.deleteKeys(prefix)` –∏–∑ `tkv.go`).
        4.  **–ó–∞–¥–∞—á–∞ 3: –û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.**
              * –ù–∞–º –Ω—É–∂–Ω–æ –¥–æ–∂–¥–∞—Ç—å—Å—è, –ø–æ–∫–∞ `m.oplogQueue` –æ–ø—É—Å—Ç–µ–µ—Ç (–≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã).
              * *–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ* `m.conf.SetReadOnly(false)`.

  * **–®–∞–≥ 16: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 5**

      * –ü—Ä–æ–≤–µ—Ä—å `flock`.
      * `?fast-meta=1`: `touch file1`, `kill -9 juicefs`. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ `mount`. –£–±–µ–¥–∏—Å—å, —á—Ç–æ `file1` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è.
      * `?fast-meta=1` (–ö–ª–∏–µ–Ω—Ç –ê) + –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç (–ö–ª–∏–µ–Ω—Ç –ë).
      * –ê: `ls /` (–∫—ç—à–∏—Ä—É–µ—Ç).
      * –ë: `mkdir /newdir_while_A_was_offline`.
      * –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –ö–ª–∏–µ–Ω—Ç–∞ –ê. `ls /` –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å `newdir_while_A_was_offline` (—Ç.–µ. –∫—ç—à –±—ã–ª —Å–±—Ä–æ—à–µ–Ω).