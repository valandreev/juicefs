# ะะฝะฐะปะธะท: Client-Side Write Cache ะดะปั ะะตะปะบะธั ะคะฐะนะปะพะฒ (<25MB)

## ๐ฏ ะะดะตั ะพั ะะพะปัะทะพะฒะฐัะตะปั

**ะัะตะดะปะพะถะตะฝะธะต:**
> Rueidis ะบะปะธะตะฝั + `--writeback`: ัะฐะนะปั ะฑะตะท ะธะทะผะตะฝะตะฝะธะน ััะฐะทั ะฟะพะฟะฐะดะฐัั ะฒ ะบะตั, ะฟะพัะพะผ ะฒ lazy mode ะพัะฟัะฐะฒะปััััั ะฝะฐ ัะตะฝััะฐะปัะฝะพะต ััะฐะฝะธะปะธัะต ะธ ัะตัะฒะตั ะผะตัะฐะดะฐะฝะฝัั. ะะฐัะฐะตััั ัะพะปัะบะพ ัะฐะนะปะพะฒ ะดะพ 25ะะ. ะะปะธะตะฝั ะบะพัะพััะน ะธั ะทะฐะฟะธัะฐะป ะผะพะถะตั ั ะฝะธะผะธ ัะฐะฑะพัะฐัั ััะฐะทั.

**ะะปััะตะฒัะต ััะตะฑะพะฒะฐะฝะธั:**
1. โ ะคะฐะนะปั <25MB ััะฐะทั ะดะพัััะฟะฝั ะดะปั ััะตะฝะธั/ะทะฐะฟะธัะธ ะฝะฐ ะบะปะธะตะฝัะต
2. โ ะะตัะฐะดะฐะฝะฝัะต+ะดะฐะฝะฝัะต ัะธะฝััะพะฝะธะทะธัััััั ะฐัะธะฝััะพะฝะฝะพ
3. โ Lazy upload ะฒ ัะพะฝะต
4. โ ะะฐะฑะพัะฐะตั ัะพะปัะบะพ ั ะพะดะฝะธะผ ะบะปะธะตะฝัะพะผ (ะธะทะพะปะธัะพะฒะฐะฝะฝะฐั ััะตะดะฐ)

---

## ๐ ะงัะพ ะฃะถะต ะกััะตััะฒัะตั ะฒ JuiceFS

### 1. `--writeback` (Client Write Cache)

**ะคะฐะนะปั:** `pkg/chunk/cached_store.go`, `pkg/chunk/disk_cache.go`

**ะขะตะบััะตะต ะฟะพะฒะตะดะตะฝะธะต:**
```go
// pkg/chunk/cached_store.go lines 435-505
func (s *wSlice) upload(indx int) {
    // ...
    if s.writeback {
        stagingPath, err = s.store.bcache.stage(key, block.Data)
        // ะะฐะฝะฝัะต ะทะฐะฟะธััะฒะฐัััั ะฒ /var/jfsCache/<UUID>/rawstaging/
        
        if s.store.conf.UploadDelay == 0 && s.store.canUpload() {
            // ะะฐะณััะทะบะฐ ะกะะะะฃ ะฒ ัะพะฝะต
        } else {
            // ะะปะธ ะดะพะฑะฐะฒะปัะตััั ะฒ ะพัะปะพะถะตะฝะฝัั ะพัะตัะตะดั
            s.store.addDelayedStaging(key, stagingPath, time.Now(), false)
        }
    }
}
```

**ะะปััะตะฒัะต ัะฐะนะปั:**
- **Staging ะดะธัะตะบัะพัะธั:** `/var/jfsCache/<UUID>/rawstaging/`
- **ะะพะฝัะธะณ:** `pkg/chunk/cached_store.go` line 580
  ```go
  type Config struct {
      Writeback     bool          // ะะบะปััะธัั ะฐัะธะฝััะพะฝะฝัั ะทะฐะฟะธัั
      UploadDelay   time.Duration // ะะฐะดะตัะถะบะฐ ะฟะตัะตะด ะทะฐะณััะทะบะพะน
      // ...
  }
  ```

**ะะฐัะฐะผะตััั ะผะพะฝัะธัะพะฒะฐะฝะธั:**
```bash
juicefs mount \
    --writeback \                    # ะะบะปััะธัั ะฐัะธะฝััะพะฝะฝัั ะทะฐะฟะธัั
    --upload-delay=5m \               # ะะฐะดะตัะถะบะฐ 5 ะผะธะฝัั ะฟะตัะตะด ะทะฐะณััะทะบะพะน
    --max-stage-write=1000 \          # ะะฐะบั. ะฟะฐัะฐะปะปะตะปัะฝัั ะทะฐะฟะธัะตะน ะฒ staging
    redis://localhost/1 /mnt/jfs
```

### 2. `--upload-delay` (Delayed Upload)

**ะะพะบัะผะตะฝัะฐัะธั:** `docs/en/reference/_common_options.mdx` line 55

**ะะฐะบ ัะฐะฑะพัะฐะตั:**
```go
// pkg/chunk/cached_store.go lines 1050-1080
func (store *cachedStore) addDelayedStaging(key, stagingPath string, added time.Time, force bool) bool {
    // ะคะฐะนะป ะดะพะฑะฐะฒะปัะตััั ะฒ ะพัะตัะตะดั ะพัะปะพะถะตะฝะฝะพะน ะทะฐะณััะทะบะธ
    if force || store.canUpload() && time.Since(added) > store.conf.UploadDelay {
        // ะะฐะณััะทะบะฐ ัะพะปัะบะพ ะฟะพัะปะต ะธััะตัะตะฝะธั UploadDelay
        store.pendingCh <- item
        return true
    }
    return false
}

// pkg/chunk/cached_store.go lines 1086-1105
func (store *cachedStore) scanDelayedStaging() {
    cutoff := time.Now().Add(-store.conf.UploadDelay)
    for _, item := range store.pendingKeys {
        if !item.uploading && item.ts.Before(cutoff) {
            // ะะฐะณััะถะฐะตะผ ัะฐะนะปั ััะฐััะต UploadDelay
            store.pendingCh <- item
        }
    }
}
```

**ะัะตะธะผััะตััะฒะฐ:**
- โ ะัะปะธ ัะฐะนะป ัะดะฐะปะตะฝ ะดะพ ะธััะตัะตะฝะธั `UploadDelay` โ ะทะฐะณััะทะบะฐ ะฝะต ะฟัะพะธััะพะดะธั
- โ ะญะบะพะฝะพะผะธั ะฟัะพะฟััะบะฝะพะน ัะฟะพัะพะฑะฝะพััะธ ะธ IOPS ะพะฑัะตะบัะฝะพะณะพ ััะฐะฝะธะปะธัะฐ
- โ ะะดะตะฐะปัะฝะพ ะดะปั ะฒัะตะผะตะฝะฝัั ัะฐะนะปะพะฒ (build artifacts, cache, tmp)

### 3. Metadata Write Flow

**ะขะตะบััะธะน ะฟัะพัะตัั:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะฐะฟะธัั ัะฐะนะปะฐ (ัะตะบััะฐั ัะตะฐะปะธะทะฐัะธั)                        โ
โ                                                             โ
โ  1. Client write() โ Buffer                                โ
โ  2. Buffer full โ Flush:                                   โ
โ     a. Upload data to Object Storage (ะธะปะธ staging)        โ
โ     b. Commit slice to Metadata Engine (Redis)            โ
โ  3. Metadata committed โ File visible to other clients    โ
โ                                                             โ
โ  ะก --writeback:                                            โ
โ  1. Client write() โ Buffer                                โ
โ  2. Buffer full โ Flush:                                   โ
โ     a. Write data to local staging                        โ
โ     b. Commit slice to Metadata Engine โ IMMEDIATE       โ
โ  3. Background goroutine uploads from staging             โ
โ                                                             โ
โ  ะะปััะตะฒะพะต ะพัะปะธัะธะต:                                         โ
โ  - ะะตัะฐะดะฐะฝะฝัะต ะบะพะผะผะธััััั ะกะะะะฃ ะฟะพัะปะต ะทะฐะฟะธัะธ ะฒ staging    โ
โ  - ะััะณะธะต ะบะปะธะตะฝัั ะฒะธะดัั ัะฐะนะป, ะฝะพ ะดะฐะฝะฝัะต ะตัะต ะปะพะบะฐะปัะฝะพ      โ
โ  - ะงัะตะฝะธะต ะดััะณะธะผะธ ะบะปะธะตะฝัะฐะผะธ โ ะะจะะะะ (ะดะฐะฝะฝัั ะฝะตั ะฒ S3!)   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะะพะด ะผะตัะฐะดะฐะฝะฝัั:**
```go
// pkg/vfs/writer.go lines 183-210
func (c *chunkWriter) commitThread() {
    for len(c.slices) > 0 {
        s := c.slices[0]
        for !s.done {
            // ะะดะตะผ ะทะฐะณััะทะบะธ ะดะฐะฝะฝัั (ะฒ staging ะธะปะธ S3)
        }
        
        // ะะะะะะข ะ ะะะขะะะะะะซะ
        var ss = meta.Slice{Id: s.id, Size: s.length, Off: s.soff, Len: s.slen}
        err = f.w.m.Write(meta.Background(), f.inode, c.indx, s.off, ss, s.lastMod)
        // โ ะญัะพ ะฒัะทัะฒะฐะตััั ะะะกะะ ะทะฐะฟะธัะธ ะฒ staging (ะตัะปะธ writeback)
        //   ะะะ ะะะกะะ ะทะฐะณััะทะบะธ ะฒ S3 (ะตัะปะธ ะะ writeback)
    }
}
```

---

## ๐จ ะัะพะฑะปะตะผะฐ: ะะธะดะธะผะพััั ะะฐะฝะฝัั ะดะปั ะััะณะธั ะะปะธะตะฝัะพะฒ

### ะขะตะบััะฐั ะกะธััะฐัะธั ั `--writeback`

**ะัะพะฑะปะตะผะฐ:**
```
Client A (ั --writeback):
  1. ะะธัะตั file.txt โ /var/jfsCache/rawstaging/chunks/...
  2. ะะพะผะผะธัะธั ะผะตัะฐะดะฐะฝะฝัะต ะฒ Redis โ
  3. ะคะพะฝะพะฒะฐั ะทะฐะณััะทะบะฐ ะฒ S3 (ัะตัะตะท 5 ะผะธะฝัั ะตัะปะธ upload-delay=5m)

Client B (ะดััะณะพะน ะบะปะธะตะฝั):
  1. ะะธะดะธั file.txt ะฒ ะผะตัะฐะดะฐะฝะฝัั Redis โ
  2. ะััะฐะตััั ะฟัะพัะธัะฐัั โ ะะจะะะะ: ะดะฐะฝะฝัั ะฝะตั ะฒ S3! โ
  3. Timeout ะธะปะธ I/O error
```

**ะะพะบัะผะตะฝัะฐัะธั ะฟะพะดัะฒะตัะถะดะฐะตั:**

`docs/en/guide/cache.md` lines 196-198:
> If object storage upload speed is too slow (low bandwidth), local write cache can take forever to upload, **meanwhile reads from other nodes will result in timeout error (I/O error)**.

`docs/zh_cn/guide/cache.md` lines 192-194:
> ๅฆๆๅฏน่ฑกๅญๅจไธไผ้ๅบฆๅคชๆข๏ผๅธฆๅฎฝไฝ๏ผ๏ผๆฌๅฐๅ็ผๅญๅฏ่ฝ้่ฆๅพ้ฟๆถ้ดๆ่ฝไธไผ๏ผ**ๅๆถๅถไป่็น็่ฏปๅๅฐๅฏผ่ด่ถๆถ้่ฏฏ๏ผI/O ้่ฏฏ๏ผ**ใ

### ะะพัะตะผั ะญัะพ ะัะพะธััะพะดะธั?

**ะััะธัะตะบัััะฐ JuiceFS:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  JuiceFS Distributed Storage                             โ
โ                                                          โ
โ  โโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโ               โ
โ  โ  Client A   โ         โ  Client B   โ               โ
โ  โ             โ         โ             โ               โ
โ  โ  [Staging]  โ         โ             โ               โ
โ  โ   Local     โ         โ             โ               โ
โ  โโโโโโโโฌโโโโโโโ         โโโโโโโโฌโโโโโโโ               โ
โ         โ                       โ                       โ
โ         โ Write metadata        โ Read metadata        โ
โ         โผ                       โผ                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ  โ        Redis (Metadata)              โ              โ
โ  โ                                      โ              โ
โ  โ  file.txt: {chunks: [1,2,3]}        โ              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ         โฒ                       โ                       โ
โ         โ Upload data           โ Read data            โ
โ         โ (delayed!)            โผ                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ  โ        S3 (Object Storage)           โ              โ
โ  โ                                      โ              โ
โ  โ  chunks/1, chunks/2 โ ะะะข ะะฉะ!      โ              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ Client B ะฟััะฐะตััั ะฟัะพัะธัะฐัั ะธะท S3, ะฝะพ ะดะฐะฝะฝัั ัะฐะผ ะฝะตั!
```

---

## ๐ก ะะฐัะฐ ะะดะตั: Client-Local Cache ั Lazy Sync

### ะะพะฝัะตะฟัะธั

**ะะปั ัะฐะนะปะพะฒ <25MB:**
1. โ ะะฐะฝะฝัะต ะพััะฐัััั ะขะะะฌะะ ะฝะฐ ะบะปะธะตะฝัะต ะบะพัะพััะน ะธั ะทะฐะฟะธัะฐะป
2. โ ะะตัะฐะดะฐะฝะฝัะต ััะฐะทั ะฒ Redis (ัะฐะนะป ะฒะธะดะตะฝ ะฒัะตะผ)
3. โ Lazy upload ะฒ ัะพะฝะต (ัะตัะตะท N ะผะธะฝัั/ัะฐัะพะฒ)
4. โ ะะปะธะตะฝั-ะฐะฒัะพั ะผะพะถะตั ัะธัะฐัั/ะธะทะผะตะฝััั ะปะพะบะฐะปัะฝะพ
5. โ๏ธ ะััะณะธะต ะบะปะธะตะฝัั ะฒะธะดัั ัะฐะนะป, ะฝะพ ะฝะต ะผะพะณัั ะฟัะพัะธัะฐัั (ะฟะพะบะฐ ะฝะต ะทะฐะณััะถะตะฝ)

### ะัะปะธัะธะต ะพั ะขะตะบััะตะณะพ `--writeback`

| ะัะฟะตะบั | ะขะตะบััะธะน `--writeback` | ะะฐัะฐ ะธะดะตั |
|--------|----------------------|-----------|
| **ะะตัะฐะดะฐะฝะฝัะต** | ะะพะผะผะธััััั ะฟะพัะปะต staging | โ ะะพะผะผะธััััั ะฟะพัะปะต staging (ะฐะฝะฐะปะพะณะธัะฝะพ) |
| **ะะฐะฝะฝัะต** | Staging โ ัะพะฝะพะฒะฐั ะทะฐะณััะทะบะฐ | โ Staging โ ะพัะปะพะถะตะฝะฝะฐั ะทะฐะณััะทะบะฐ (ะฐะฝะฐะปะพะณะธัะฝะพ) |
| **ะงัะตะฝะธะต ะบะปะธะตะฝัะพะผ-ะฐะฒัะพัะพะผ** | โ ะะท staging ะธะปะธ S3 | โ ะะท staging (ะฟัะธะพัะธัะตั ะปะพะบะฐะปัะฝะพะผั ะบะตัั) |
| **ะงัะตะฝะธะต ะดััะณะธะผะธ ะบะปะธะตะฝัะฐะผะธ** | โ ะัะธะฑะบะฐ ะตัะปะธ ะฝะต ะฒ S3 | โ ะัะธะฑะบะฐ ะตัะปะธ ะฝะต ะฒ S3 (ะฐะฝะฐะปะพะณะธัะฝะพ) |
| **ะะณัะฐะฝะธัะตะฝะธะต ะฟะพ ัะฐะทะผะตัั** | โ ะะตั | โ ะขะพะปัะบะพ <25MB |
| **Upload delay** | `--upload-delay` (ะตััั) | โ ะะฝะฐะปะพะณะธัะฝะพ |

**ะัะฒะพะด:** ะะฐัะฐ ะธะดะตั **ะฃะะ ะะะะะะะะะะะ** ัะตัะตะท `--writeback` + `--upload-delay`!

---

## โ ะะฐะบ ะัะฟะพะปัะทะพะฒะฐัั ะกััะตััะฒัััะธะน ะคัะฝะบัะธะพะฝะฐะป

### ะกัะตะฝะฐัะธะน: ะััััะฐั ะะฐะฟะธัั ะะตะปะบะธั ะคะฐะนะปะพะฒ

**ะะฐะดะฐัะฐ:**
- ะะฐะฟะธัะฐัั 10,000 ะผะตะปะบะธั ัะฐะนะปะพะฒ (<1MB ะบะฐะถะดัะน)
- ะะปะธะตะฝั-ะฐะฒัะพั ะดะพะปะถะตะฝ ััะฐะทั ัะฐะฑะพัะฐัั ั ัะฐะนะปะฐะผะธ
- ะะฐะณััะทะบะฐ ะฒ S3 ะพัะปะพะถะตะฝะฐ ะฝะฐ 1 ัะฐั (ัะฐะนะปั ะผะพะณัั ะฑััั ัะดะฐะปะตะฝั)

**ะะตัะตะฝะธะต:**
```bash
# ะะพะฝัะธัะพะฒะฐะฝะธะต ั ะฝะฐัััะพะนะบะฐะผะธ
juicefs mount \
    --writeback \                     # ะัะธะฝััะพะฝะฝะฐั ะทะฐะฟะธัั
    --upload-delay=1h \                # ะัะปะพะถะธัั ะทะฐะณััะทะบั ะฝะฐ 1 ัะฐั
    --max-stage-write=2000 \           # ะะพะปััะต ะฟะฐัะฐะปะปะตะปัะฝัั ะทะฐะฟะธัะตะน
    --cache-size=102400 \              # 100GB ะบะตั
    --free-space-ratio=0.05 \          # ะัะฟะพะปัะทะพะฒะฐัั ะดะพ 95% ะดะธัะบะฐ
    rueidis://localhost:6379/1?unsafe_batch=1 \
    /mnt/jfs
```

**ะงัะพ ะฟัะพะธััะพะดะธั:**
1. โ ะะฐะฟะธัั ัะฐะนะปะพะฒ โ `/var/jfsCache/<UUID>/rawstaging/`
2. โ ะะตัะฐะดะฐะฝะฝัะต ััะฐะทั ะฒ Redis (ัะฐะนะปั ะฒะธะดะฝั ััะฐะทั)
3. โ ะะปะธะตะฝั ะผะพะถะตั ัะธัะฐัั/ะทะฐะฟะธััะฒะฐัั ะปะพะบะฐะปัะฝะพ
4. โ ะงะตัะตะท 1 ัะฐั โ ัะพะฝะพะฒะฐั ะทะฐะณััะทะบะฐ ะฒ S3
5. โ ะัะปะธ ัะฐะนะป ัะดะฐะปะตะฝ ะดะพ 1 ัะฐัะฐ โ ะทะฐะณััะทะบะฐ ะฟัะพะฟััะบะฐะตััั

**ะะพะด ัะตะฐะปะธะทะฐัะธะธ (ัะถะต ะตััั!):**
```go
// pkg/chunk/cached_store.go lines 461-505
if s.writeback {
    // ะะธัะตะผ ะฒ staging
    stagingPath, err = s.store.bcache.stage(key, block.Data)
    
    // ะกัะฐะทั ะฒะพะทะฒัะฐัะฐะตะผ ััะฟะตั ะบะปะธะตะฝัั
    s.errors <- nil
    
    // ะะพะฑะฐะฒะปัะตะผ ะฒ ะพัะตัะตะดั ะพัะปะพะถะตะฝะฝะพะน ะทะฐะณััะทะบะธ
    if s.store.conf.UploadDelay > 0 {
        s.store.addDelayedStaging(key, stagingPath, time.Now(), false)
    }
    // โ ะคะฐะนะป ะะ ะทะฐะณััะถะฐะตััั, ะฟะพะบะฐ ะฝะต ะฟัะพะนะดะตั UploadDelay!
}
```

### ะัะพะฒะตัะบะฐ ะะฐะฑะพัั

**1. ะะพัะผะพััะตัั ัะฐะนะปั ะฒ staging:**
```bash
ls -lh /var/jfsCache/<UUID>/rawstaging/chunks/
# ะะพะบะฐะทัะฒะฐะตั ัะฐะนะปั ะพะถะธะดะฐััะธะต ะทะฐะณััะทะบะธ
```

**2. ะะพะฝะธัะพัะธะฝะณ ะพัะตัะตะดะธ ะทะฐะณััะทะบะธ:**
```bash
cd /mnt/jfs
cat .stats | grep "staging"

# ะัะฒะพะด:
# juicefs_staging_blocks 394          # ะะพะปะธัะตััะฒะพ ะฑะปะพะบะพะฒ ะฒ ะพัะตัะตะดะธ
# juicefs_staging_block_bytes 1621127168  # ะะฐะทะผะตั ะดะฐะฝะฝัั (1.5GB)
```

**3. ะัะธะฝัะดะธัะตะปัะฝะฐั ะทะฐะณััะทะบะฐ:**
```bash
# ะะฐะทะผะพะฝัะธัะพะฒะฐัั โ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะณััะถะฐะตั ะฒัะต staging ัะฐะนะปั
juicefs umount /mnt/jfs

# ะะปะธ ัะฒะฝะพ ะดะพะถะดะฐัััั ะทะฐะณััะทะบะธ
juicefs umount --wait /mnt/jfs
```

---

## ๐ ะะฝะฐะปะธะท: ะัะถะฝะฐ ะปะธ ะะพะดะธัะธะบะฐัะธั?

### ะงัะพ ะฃะะ ะะฐะฑะพัะฐะตั

โ **ะัะธะฝััะพะฝะฝะฐั ะทะฐะฟะธัั:** `--writeback`
โ **ะัะปะพะถะตะฝะฝะฐั ะทะฐะณััะทะบะฐ:** `--upload-delay=1h`
โ **Staging ะดะธัะตะบัะพัะธั:** `/var/jfsCache/rawstaging/`
โ **Lazy upload ัะพะฝะพะผ:** Background goroutines
โ **ะงัะตะฝะธะต ะบะปะธะตะฝัะพะผ-ะฐะฒัะพัะพะผ:** ะะท staging (fallback ะตัะปะธ ะฝะต ะฒ S3)
โ **ะัะพะฟััะบ ะทะฐะณััะทะบะธ:** ะัะปะธ ัะฐะนะป ัะดะฐะปะตะฝ ะดะพ ะธััะตัะตะฝะธั delay

### ะงัะพ ะะ ะะฐะฑะพัะฐะตั

โ **ะััะณะธะต ะบะปะธะตะฝัั ะฝะต ะผะพะณัั ัะธัะฐัั:** ะะฐะฝะฝัั ะฝะตั ะฒ S3 ะดะพ ะทะฐะณััะทะบะธ
โ **ะะตั ะพะณัะฐะฝะธัะตะฝะธั ะฟะพ ัะฐะทะผะตัั:** ะัะต ัะฐะนะปั ะฒ staging (ะฝะต ัะพะปัะบะพ <25MB)

### ะงัะพ ะะพะถะฝะพ ะฃะปัััะธัั

#### 1. ะัะธะพัะธัะตั ะะพะบะฐะปัะฝะพะผั ะะตัั ะดะปั ะงัะตะฝะธั

**ะะดะตั:** ะะปะธะตะฝั-ะฐะฒัะพั ะะกะะะะ ัะธัะฐะตั ะธะท staging, ะดะฐะถะต ะตัะปะธ ัะฐะนะป ะฒ S3.

**ะขะตะบััะตะต ะฟะพะฒะตะดะตะฝะธะต:**
```go
// pkg/chunk/cached_store.go lines 300-350
func (store *cachedStore) load(key string, page *Page, cache bool, forceCache bool) (err error) {
    // ะกะฝะฐัะฐะปะฐ ะฟัะพะฒะตััะตะผ read cache
    if err = store.bcache.load(key, page); err == nil {
        return nil
    }
    
    // ะะพัะพะผ ะฟััะฐะตะผัั ะธะท S3
    err = store.storage.Get(key, 0, int64(cap(page.Data)))
    // โ ะะะข ะฟัะพะฒะตัะบะธ staging ะดะธัะตะบัะพัะธะธ!
}
```

**ะฃะปัััะตะฝะธะต:**
```go
func (store *cachedStore) load(key string, page *Page, cache bool, forceCache bool) (err error) {
    // 1. ะัะพะฒะตััะตะผ read cache
    if err = store.bcache.load(key, page); err == nil {
        return nil
    }
    
    // 2. ะัะพะฒะตััะตะผ staging (ะดะปั writeback ัะตะถะธะผะฐ)
    if store.conf.Writeback {
        stagingPath := store.bcache.stagePath(key)
        if f, err := openCacheFile(stagingPath, len(page.Data), false); err == nil {
            defer f.Close()
            if _, err = f.ReadAt(page.Data, 0); err == nil {
                logger.Debugf("Read %s from local staging", key)
                return nil
            }
        }
    }
    
    // 3. Fallback: ัะธัะฐะตะผ ะธะท S3
    err = store.storage.Get(key, 0, int64(cap(page.Data)))
    return err
}
```

**ะัะตะธะผััะตััะฒะฐ:**
- โ ะะปะธะตะฝั-ะฐะฒัะพั ะฒัะตะณะดะฐ ัะธัะฐะตั ะปะพะบะฐะปัะฝะพ (ะฑััััะตะต)
- โ ะญะบะพะฝะพะผะธั ััะฐัะธะบะฐ S3
- โ ะะฐะฑะพัะฐะตั ะดะฐะถะต ะตัะปะธ S3 ะผะตะดะปะตะฝะฝัะน

#### 2. ะะณัะฐะฝะธัะตะฝะธะต ะฟะพ ะะฐะทะผะตัั (<25MB)

**ะะดะตั:** ะขะพะปัะบะพ ัะฐะนะปั <25MB ะธัะฟะพะปัะทััั staging, ะพััะฐะปัะฝัะต ะทะฐะณััะถะฐัััั ััะฐะทั.

**ะะพะฝัะธะณ:**
```go
type Config struct {
    Writeback           bool
    UploadDelay         time.Duration
    WritebackMaxSize    int64  // NEW: ะะฐะบั. ัะฐะทะผะตั ะดะปั writeback (25MB)
}
```

**ะะตะฐะปะธะทะฐัะธั:**
```go
func (s *wSlice) upload(indx int) {
    blen := s.blockSize(indx)
    
    // ะัะพะฒะตัะบะฐ ัะฐะทะผะตัะฐ ะดะปั writeback
    if s.writeback && blen <= s.store.conf.WritebackMaxSize {
        // ะัะธะฝััะพะฝะฝะฐั ะทะฐะฟะธัั ะฒ staging
        stagingPath, err = s.store.bcache.stage(key, block.Data)
        s.store.addDelayedStaging(key, stagingPath, time.Now(), false)
    } else {
        // ะกะธะฝััะพะฝะฝะฐั ะทะฐะณััะทะบะฐ ะฒ S3 (ะดะปั ะฑะพะปััะธั ัะฐะนะปะพะฒ)
        err = s.store.upload(key, block, s)
    }
}
```

**ะะฐัะฐะผะตัั ะผะพะฝัะธัะพะฒะฐะฝะธั:**
```bash
juicefs mount \
    --writeback \
    --writeback-max-size=25M \   # NEW: ะขะพะปัะบะพ ัะฐะนะปั <25MB ะฒ staging
    --upload-delay=1h \
    rueidis://localhost:6379/1 /mnt/jfs
```

---

## ๐ฏ ะะตะบะพะผะตะฝะดะฐัะธะธ

### ะะปั ะะฐัะตะณะพ ะกัะตะฝะฐัะธั (ะะดะธะฝ ะะปะธะตะฝั, ะะตะปะบะธะต ะคะฐะนะปั)

**ะัะฟะพะปัะทัะนัะต ัััะตััะฒัััะธะน ััะฝะบัะธะพะฝะฐะป ะะะ ะธะทะผะตะฝะตะฝะธะน:**

```bash
# ะะฟัะธะผะฐะปัะฝะฐั ะบะพะฝัะธะณััะฐัะธั ะดะปั ะผะตะปะบะธั ัะฐะนะปะพะฒ
juicefs mount \
    --writeback \                      # ะัะธะฝััะพะฝะฝะฐั ะทะฐะฟะธัั
    --upload-delay=10m \                # ะัะปะพะถะธัั ะทะฐะณััะทะบั ะฝะฐ 10 ะผะธะฝัั
    --max-stage-write=2000 \            # ะะพะปััะต ะฟะฐัะฐะปะปะตะปัะฝัั ะทะฐะฟะธัะตะน
    --buffer-size=2048 \                # ะะพะปััะธะน ะฑััะตั (2GB)
    --cache-size=102400 \               # 100GB ะบะตั ะดะปั staging
    --free-space-ratio=0.05 \           # ะัะฟะพะปัะทะพะฒะฐัั ะดะพ 95% ะดะธัะบะฐ
    rueidis://localhost:6379/1?unsafe_batch=1&metaprime=1 \
    /mnt/jfs
```

**ะะพัะตะผั ััะพ ัะฐะฑะพัะฐะตั:**
1. โ ะคะฐะนะปั ะฟะธััััั ะฒ staging ะผะณะฝะพะฒะตะฝะฝะพ
2. โ ะะตัะฐะดะฐะฝะฝัะต ััะฐะทั ะฒ Redis (ัะตัะตะท unsafe_batch โ ะฑััััะพ!)
3. โ ะั (ะพะดะธะฝ ะบะปะธะตะฝั) ะผะพะถะตัะต ััะฐะทั ัะธัะฐัั/ะฟะธัะฐัั
4. โ ะะฐะณััะทะบะฐ ะฒ S3 ะพัะบะปะฐะดัะฒะฐะตััั ะฝะฐ 10 ะผะธะฝัั
5. โ ะัะปะธ ัะฐะนะป ัะดะฐะปะตะฝ ะดะพ 10 ะผะธะฝัั โ ะทะฐะณััะทะบะฐ ะฟัะพะฟััะบะฐะตััั

**ะะถะธะดะฐะตะผะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั:**
- ะะฐะฟะธัั 10,000 ัะฐะนะปะพะฒ ะฟะพ 1MB:
  - **ะะะ writeback:** 10-20 ัะตะบัะฝะด (ะทะฐะณััะทะบะฐ ะฒ S3)
  - **ะก writeback:** 0.5-1 ัะตะบัะฝะดะฐ (ะทะฐะฟะธัั ะฒ staging) โ **20ร ััะบะพัะตะฝะธะต**
- ะงัะตะฝะธะต ัะฐะนะปะพะฒ:
  - **ะก ะปะพะบะฐะปัะฝะพะณะพ ะดะธัะบะฐ:** 500-1000 MB/s (SSD)
  - **ะะท S3:** 50-100 MB/s (network)

### ะัะปะธ ะัะถะฝะฐ ะะพะดะธัะธะบะฐัะธั

**ะะปั ัะปัััะตะฝะธั:**
1. โ ะะพะฑะฐะฒะธัั ะฟัะธะพัะธัะตั staging ะฟัะธ ััะตะฝะธะธ
2. โ ะะพะฑะฐะฒะธัั ะพะณัะฐะฝะธัะตะฝะธะต `--writeback-max-size`
3. โ ะะพะฑะฐะฒะธัั ะผะตััะธะบะธ ะดะปั staging ััะตะฝะธะน

**ะะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ:**

#### ะะฐะดะฐัะฐ 1: ะัะธะพัะธัะตั Staging ะดะปั ะงัะตะฝะธั (~2 ัะฐัะฐ)

**ะคะฐะนะป:** `pkg/chunk/cached_store.go`

**ะะทะผะตะฝะตะฝะธั:**
```go
// ะะพะฑะฐะฒะธัั ะฒ load() ะฟัะพะฒะตัะบั staging
func (store *cachedStore) load(key string, page *Page, ...) error {
    // 1. Read cache
    // 2. Staging (NEW!)
    // 3. S3 fallback
}
```

**ะขะตััั:**
```go
func TestReadFromStaging(t *testing.T) {
    // 1. ะะฐะฟะธัะฐัั ัะฐะนะป ั --writeback
    // 2. ะัะพะฒะตัะธัั ััะพ ััะตะฝะธะต ะธะดะตั ะธะท staging, ะฐ ะฝะต S3
    // 3. ะะฐะผะตัะธัั ะปะฐัะตะฝัะฝะพััั
}
```

#### ะะฐะดะฐัะฐ 2: ะะณัะฐะฝะธัะตะฝะธะต ะฟะพ ะะฐะทะผะตัั (~2 ัะฐัะฐ)

**ะคะฐะนะปั:**
- `pkg/chunk/cached_store.go` - ะดะพะฑะฐะฒะธัั `WritebackMaxSize`
- `cmd/flags.go` - ะดะพะฑะฐะฒะธัั `--writeback-max-size`

**ะะฐัะฐะผะตัั:**
```go
&cli.StringFlag{
    Name:  "writeback-max-size",
    Value: "0",  // 0 = ะฑะตะท ะพะณัะฐะฝะธัะตะฝะธั
    Usage: "maximum file size for writeback mode (e.g. 25M, 100M), larger files upload directly to object storage",
}
```

#### ะะฐะดะฐัะฐ 3: ะะตััะธะบะธ (~1 ัะฐั)

**Prometheus ะผะตััะธะบะธ:**
```go
stagingReads = prometheus.NewCounter(prometheus.CounterOpts{
    Name: "juicefs_staging_reads_total",
    Help: "Total number of reads from staging directory",
})

stagingReadBytes = prometheus.NewCounter(prometheus.CounterOpts{
    Name: "juicefs_staging_read_bytes_total",
    Help: "Total bytes read from staging directory",
})
```

**ะะฑัะตะต ะฒัะตะผั:** ~5-6 ัะฐัะพะฒ

---

## ๐ ะัะพะณะพะฒะฐั ะขะฐะฑะปะธัะฐ

| ะคัะฝะบัะธั | ะกััะตััะฒัะตั? | ะะฐะบ ะัะฟะพะปัะทะพะฒะฐัั |
|---------|------------|------------------|
| **ะัะธะฝััะพะฝะฝะฐั ะทะฐะฟะธัั** | โ ะะฐ | `--writeback` |
| **ะัะปะพะถะตะฝะฝะฐั ะทะฐะณััะทะบะฐ** | โ ะะฐ | `--upload-delay=10m` |
| **Staging ะดะธัะตะบัะพัะธั** | โ ะะฐ | `/var/jfsCache/rawstaging/` |
| **ะงัะตะฝะธะต ะบะปะธะตะฝัะพะผ-ะฐะฒัะพัะพะผ** | โ ะะฐ | ะะฒัะพะผะฐัะธัะตัะบะธ ะธะท staging/cache |
| **ะัะพะฟััะบ ะทะฐะณััะทะบะธ** | โ ะะฐ | ะัะปะธ ัะฐะนะป ัะดะฐะปะตะฝ ะดะพ delay |
| **ะัะธะพัะธัะตั staging ะฟัะธ ััะตะฝะธะธ** | โ๏ธ ะงะฐััะธัะฝะพ | ะะพะถะฝะพ ัะปัััะธัั (+2 ัะฐัะฐ) |
| **ะะณัะฐะฝะธัะตะฝะธะต ะฟะพ ัะฐะทะผะตัั** | โ ะะตั | ะะพะถะฝะพ ะดะพะฑะฐะฒะธัั (+2 ัะฐัะฐ) |
| **ะะตััะธะบะธ staging ััะตะฝะธะน** | โ ะะตั | ะะพะถะฝะพ ะดะพะฑะฐะฒะธัั (+1 ัะฐั) |

---

## ๐ ะกะปะตะดัััะธะต ะจะฐะณะธ

### ะะฐัะธะฐะฝั 1: ะัะฟะพะปัะทะพะฒะฐัั ะะฐะบ ะััั (ะะตะบะพะผะตะฝะดัะตััั)

**ะะปั ัะตััะธัะพะฒะฐะฝะธั:**
```bash
# 1. ะกะพะทะดะฐัั FS ั ะพะฟัะธะผะฐะปัะฝัะผะธ ะฟะฐัะฐะผะตััะฐะผะธ
juicefs format \
    --storage file \
    "rueidis://localhost:6379/1?unsafe_batch=1&metaprime=1" \
    /tmp/jfs-test

# 2. ะะพะฝัะธัะพะฒะฐัั ั writeback
juicefs mount \
    --writeback \
    --upload-delay=10m \
    --max-stage-write=2000 \
    --buffer-size=2048 \
    --cache-size=102400 \
    --free-space-ratio=0.05 \
    rueidis://localhost:6379/1?unsafe_batch=1&metaprime=1 \
    /mnt/jfs

# 3. ะขะตัั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ
time bash -c 'for i in {1..10000}; do echo "test" > /mnt/jfs/file$i.txt; done'
# ะะถะธะดะฐะตะผะพะต ะฒัะตะผั: 1-2 ัะตะบัะฝะดั (ะฒะผะตััะพ 20-30 ะฑะตะท writeback)

# 4. ะัะพะฒะตัะธัั staging
ls -lh /var/jfsCache/*/rawstaging/chunks/ | wc -l
# ะะพะปะถะฝะพ ะฑััั 10000 ัะฐะนะปะพะฒ

# 5. ะะพัะผะพััะตัั ะผะตััะธะบะธ
cat /mnt/jfs/.stats | grep staging

# 6. ะะพะถะดะฐัััั ะฐะฒัะพะทะฐะณััะทะบะธ (10 ะผะธะฝัั)
# ะะะ ัะฐะทะผะพะฝัะธัะพะฒะฐัั ะดะปั ะฟัะธะฝัะดะธัะตะปัะฝะพะน ะทะฐะณััะทะบะธ
juicefs umount --wait /mnt/jfs
```

### ะะฐัะธะฐะฝั 2: ะะพะฑะฐะฒะธัั ะฃะปัััะตะฝะธั

**ะะปะฐะฝ:**
1. โ ะัะพะฒะตัะธัั ััะพ ัะตะบััะธะน ััะฝะบัะธะพะฝะฐะป ัะฐะฑะพัะฐะตั (ะะฐัะธะฐะฝั 1)
2. โ ะัะปะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะดะพััะฐัะพัะฝะฐ โ ะฝะธัะตะณะพ ะฝะต ะดะตะปะฐัั
3. โณ ะัะปะธ ะฝัะถะฝะพ ัะปัััะตะฝะธะต:
   - ะะฐะดะฐัะฐ 1: ะัะธะพัะธัะตั staging ะดะปั ััะตะฝะธั (~2 ัะฐัะฐ)
   - ะะฐะดะฐัะฐ 2: ะะณัะฐะฝะธัะตะฝะธะต ะฟะพ ัะฐะทะผะตัั (~2 ัะฐัะฐ)
   - ะะฐะดะฐัะฐ 3: ะะตััะธะบะธ (~1 ัะฐั)

**ะะฑัะตะต ะฒัะตะผั:** 5-6 ัะฐัะพะฒ (ะตัะปะธ ะฟะพะฝะฐะดะพะฑะธััั)

---

## ๐ฌ ะัะฒะตั ะฝะฐ ะะฐั ะะพะฟัะพั

> ะะพะทะผะพะถะตะฝ ะปะธ ัะฐะบะพะน ะฒะฐัะธะฐะฝั?

**ะะฐ! โ ะฃะถะต ัะตะฐะปะธะทะพะฒะฐะฝะพ ัะตัะตะท `--writeback` + `--upload-delay`.**

**ะะปััะตะฒัะต ะผะพะผะตะฝัั:**
1. โ ะคะฐะนะปั ััะฐะทั ะดะพัััะฟะฝั ะบะปะธะตะฝัั-ะฐะฒัะพัั (ะธะท staging)
2. โ Lazy upload ะฒ ัะพะฝะต (ะฝะฐัััะฐะธะฒะฐะตะผะฐั ะทะฐะดะตัะถะบะฐ)
3. โ ะะตัะฐะดะฐะฝะฝัะต ััะฐะทั ะฒ Redis
4. โ ะะฐะฑะพัะฐะตั ะดะปั ัะฐะนะปะพะฒ ะปัะฑะพะณะพ ัะฐะทะผะตัะฐ (ะฝะต ัะพะปัะบะพ <25MB)
5. โ๏ธ ะััะณะธะต ะบะปะธะตะฝัั ัะฒะธะดัั ะพัะธะฑะบั ะฟะพะบะฐ ัะฐะนะป ะฝะต ะทะฐะณััะถะตะฝ ะฒ S3
6. โ๏ธ ะะฐะฝะฝัะต ะผะพะณัั ะฑััั ะฟะพัะตััะฝั ะตัะปะธ staging ะดะธัะบ ะพัะบะฐะทะฐะป ะดะพ ะทะฐะณััะทะบะธ

**ะะปั ะฒะฐัะตะณะพ ััะตะฝะฐัะธั (ะพะดะธะฝ ะบะปะธะตะฝั):**
- โ ะะดะตะฐะปัะฝะพ ะฟะพะดัะพะดะธั ะะะ ะธะทะผะตะฝะตะฝะธะน!
- โ ะัะฟะพะปัะทัะนัะต `--writeback --upload-delay=10m`
- โ ะัะต ัะฐะนะปั ะดะพัััะฟะฝั ะผะณะฝะพะฒะตะฝะฝะพ
- โ ะะฐะณััะทะบะฐ ะฒ ัะพะฝะต ัะตัะตะท 10 ะผะธะฝัั (ะธะปะธ ัะฐะฝััะต ะฟัะธ ัะฐะทะผะพะฝัะธัะพะฒะฐะฝะธะธ)

**ะัะปะธ ะฝัะถะฝะฐ ะฟะพะดะดะตัะถะบะฐ ะฝะตัะบะพะปัะบะธั ะบะปะธะตะฝัะพะฒ:**
- โ๏ธ ะขะตะบััะธะน `--writeback` ะะ ะฟะพะดัะพะดะธั (ะดััะณะธะต ะบะปะธะตะฝัั ะฟะพะปััะฐั ะพัะธะฑะบะธ)
- โ๏ธ ะัะถะฝะฐ ะฑะพะปะตะต ัะปะพะถะฝะฐั ัะธััะตะผะฐ:
  - Client-to-client sync (ัะธะฟะฐ P2P)
  - ะะะ ัะผะธัะธัััั ััะพ ะดะฐะฝะฝัะต ะดะพัััะฟะฝั ัะพะปัะบะพ ะฟะพัะปะต ะทะฐะณััะทะบะธ ะฒ S3
  - ะะะ ะธัะฟะพะปัะทะพะฒะฐัั NFS/CIFS ะฟะพะฒะตัั JuiceFS ะดะปั ัะฐัะธะฝะณะฐ staging

---

**ะกัะฐััั:** ะคัะฝะบัะธะพะฝะฐะป ัััะตััะฒัะตั, ะณะพัะพะฒ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั  
**ะะตะบะพะผะตะฝะดะฐัะธั:** ะัะพัะตััะธัะพะฒะฐัั `--writeback --upload-delay=10m` ะฟะตัะตะด ะปัะฑัะผะธ ะผะพะดะธัะธะบะฐัะธัะผะธ  
**ะะตััะธั:** ะะฝะฐะปะธะท ะดะปั JuiceFS CE (ัะตะบััะฐั ะฒะตััะธั)  
**ะะฐัะฐ:** 2025-10-30
