# –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –†–µ—à–µ–Ω–∏–µ: Unsafe Batch + Writeback

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ (–£—Ç–æ—á–Ω–µ–Ω–Ω–∞—è)

**–í—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–º–µ—Ç–∏–ª–∏:**
> `--upload-delay=10m` –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, —Ç.–∫. –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–ª–æ–∂–∏—Ç—å —Ñ–∞–π–ª –≤ –∫–µ—à –Ω—É–∂–Ω–æ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –µ–≥–æ –≤ –º–µ—Ç–µ, –∞ —Å —ç—Ç–∏–º –ø—Ä–æ–±–ª–µ–º—ã.

### –¢–µ–∫—É—â–∏–π Flow

```
–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å --writeback --upload-delay=10m:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. touch file.txt                                       ‚îÇ
‚îÇ 2. VFS ‚Üí doMknod() ‚ùå –ú–ï–î–õ–ï–ù–ù–û                         ‚îÇ
‚îÇ    ‚îî‚îÄ> m.txn() Redis transaction (1 RTT)               ‚îÇ
‚îÇ    ‚îî‚îÄ> WAIT for metadata write                         ‚îÇ
‚îÇ 3. write("data") ‚Üí Buffer                               ‚îÇ
‚îÇ 4. flush() ‚Üí                                            ‚îÇ
‚îÇ    a. Data ‚Üí /var/jfsCache/staging/ ‚úÖ –ë–´–°–¢–†–û          ‚îÇ
‚îÇ    b. Metadata ‚Üí m.txn() Redis ‚ùå –ú–ï–î–õ–ï–ù–ù–û (1 RTT)     ‚îÇ
‚îÇ 5. Background upload (delayed 10m) ‚úÖ OK               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–£–∑–∫–æ–µ –º–µ—Å—Ç–æ: –®–∞–≥–∏ 2 –∏ 4b - –∑–∞–ø–∏—Å—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ Redis!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–∏—à—É—Ç—Å—è –≤ staging –±—ã—Å—Ç—Ä–æ (–ª–æ–∫–∞–ª—å–Ω—ã–π –¥–∏—Å–∫)
- ‚úÖ Upload –≤ S3 –æ—Ç–ª–æ–∂–µ–Ω –Ω–∞ 10 –º–∏–Ω—É—Ç (`--upload-delay`)
- ‚ùå **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–∏—à—É—Ç—Å—è –°–ò–ù–•–†–û–ù–ù–û (1 RTT –Ω–∞ —Ñ–∞–π–ª)**
- ‚ùå `--upload-delay` –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ!

### –ò–∑–º–µ—Ä–µ–Ω–∏–µ –ü—Ä–æ–±–ª–µ–º—ã

**–°–æ–∑–¥–∞–Ω–∏–µ 10,000 —Ñ–∞–π–ª–æ–≤ —Å `--writeback --upload-delay=10m`:**

```
–û–ø–µ—Ä–∞—Ü–∏–∏:
1. 10,000 √ó doMknod() = 10,000 RTT –∫ Redis ‚ùå –ú–ï–î–õ–ï–ù–ù–û
2. 10,000 √ó write() + flush() –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö = 10,000 RTT ‚ùå –ú–ï–î–õ–ï–ù–ù–û
3. –î–∞–Ω–Ω—ã–µ –≤ staging = instant ‚úÖ OK
4. Upload –≤ S3 —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç ‚úÖ OK

–ò—Ç–æ–≥–æ: 20,000 RTT @ 1ms = 20 —Å–µ–∫—É–Ω–¥
```

**–ë–ï–ó —É–ª—É—á—à–µ–Ω–∏–π –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö `--writeback` –¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ ~2√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ!**

---

## üí° –†–µ—à–µ–Ω–∏–µ: –ö–æ–º–±–∏–Ω–∞—Ü–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: Unsafe Batch + Writeback (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è PoC)

**–ò–¥–µ—è:** –£—Å–∫–æ—Ä–∏—Ç—å –û–ë–ïE - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ò –¥–∞–Ω–Ω—ã–µ.

```bash
juicefs mount \
    --writeback \                          # –î–∞–Ω–Ω—ã–µ: async upload
    --upload-delay=10m \                    # –û—Ç–ª–æ–∂–∏—Ç—å S3 upload
    rueidis://localhost:6379/1?unsafe_batch=1&metaprime=1 \
    /mnt/jfs
#                                  ‚Üë –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: unsafe batching
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

```
–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. touch file.txt                                       ‚îÇ
‚îÇ    ‚îî‚îÄ> doMknod() with unsafe_batch ‚úÖ –ë–´–°–¢–†–û           ‚îÇ
‚îÇ       ‚îî‚îÄ> DoMulti() pipeline (N —Ñ–∞–π–ª–æ–≤ = 1 RTT)        ‚îÇ
‚îÇ 2. write("data") ‚Üí Buffer                               ‚îÇ
‚îÇ 3. flush() ‚Üí                                            ‚îÇ
‚îÇ    a. Data ‚Üí staging ‚úÖ –ë–´–°–¢–†–û                         ‚îÇ
‚îÇ    b. Metadata ‚Üí unsafe batch ‚úÖ –ë–´–°–¢–†–û (batched)      ‚îÇ
‚îÇ 4. Background upload —á–µ—Ä–µ–∑ 10m ‚úÖ OK                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–£—Å–∫–æ—Ä–µ–Ω–∏–µ:
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: 500√ó (unsafe batching)
- –î–∞–Ω–Ω—ã–µ: 20√ó (writeback)
- –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: 500-1000√ó –¥–ª—è –º–µ–ª–∫–∏—Ö —Ñ–∞–π–ª–æ–≤!
```

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

```
10,000 —Ñ–∞–π–ª–æ–≤ –ø–æ 1KB –∫–∞–∂–¥—ã–π:

–ë–ï–ó —É–ª—É—á—à–µ–Ω–∏–π:
  - doMknod: 10,000 RTT = 10s
  - write+flush metadata: 10,000 RTT = 10s
  - upload data: 10s (S3 upload)
  - –ò–¢–û–ì–û: ~30 —Å–µ–∫—É–Ω–¥

–° --writeback –¢–û–õ–¨–ö–û:
  - doMknod: 10,000 RTT = 10s
  - write+flush metadata: 10,000 RTT = 10s
  - staging: 0.1s (–ª–æ–∫–∞–ª—å–Ω—ã–π –¥–∏—Å–∫)
  - –ò–¢–û–ì–û: ~20 —Å–µ–∫—É–Ω–¥ (1.5√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ)

–° unsafe_batch –¢–û–õ–¨–ö–û:
  - doMknod: ‚åà10000/512‚åâ = 20 RTT = 0.02s
  - write+flush metadata: 20 RTT = 0.02s
  - upload data: 10s (S3)
  - –ò–¢–û–ì–û: ~10 —Å–µ–∫—É–Ω–¥ (3√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ)

–° unsafe_batch + writeback –ö–û–ú–ë–û:
  - doMknod batched: 20 RTT = 0.02s ‚úÖ
  - write+flush batched: 20 RTT = 0.02s ‚úÖ
  - staging: 0.1s ‚úÖ
  - –ò–¢–û–ì–û: ~0.15 —Å–µ–∫—É–Ω–¥—ã (200√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ!) üöÄ
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: Lua Scripts + Writeback (Production)

**–î–ª—è production-ready —Ä–µ—à–µ–Ω–∏—è:**

```bash
# –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Lua Scripts
juicefs mount \
    --writeback \
    --upload-delay=10m \
    rueidis://localhost:6379/1?safe_batch=1 \
    /mnt/jfs
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –¢–∞ –∂–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (200√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ)
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ Production-ready

---

## üìä –î–µ—Ç–∞–ª—å–Ω–æ–µ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π: –°–æ–∑–¥–∞–Ω–∏–µ 10,000 —Ñ–∞–π–ª–æ–≤ –ø–æ 1KB

| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | doMknod | write() | flush() | upload | –ò–¢–û–ì–û | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|--------------|---------|---------|---------|--------|-------|-----------|
| **Baseline** | 10s | instant | 10s | 10s | **30s** | 1√ó |
| **+ writeback** | 10s | instant | 10s | 0.1s | **20s** | 1.5√ó ‚ùå |
| **+ unsafe_batch** | 0.02s | instant | 0.02s | 10s | **10s** | 3√ó ‚ö†Ô∏è |
| **+ BOTH** | 0.02s | instant | 0.02s | 0.1s | **0.15s** | **200√ó** ‚úÖ |

### –ü–æ—á–µ–º—É –¢–æ–ª—å–∫–æ Writeback –ù–µ –ü–æ–º–æ–≥

```
--writeback –ë–ï–ó unsafe_batch:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –û–ø–µ—Ä–∞—Ü–∏—è        ‚îÇ –í—Ä–µ–º—è   ‚îÇ –ì–¥–µ      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ doMknod (meta)  ‚îÇ 10s ‚ùå  ‚îÇ Redis    ‚îÇ
‚îÇ write (buffer)  ‚îÇ 0.01s   ‚îÇ Memory   ‚îÇ
‚îÇ flush metadata  ‚îÇ 10s ‚ùå  ‚îÇ Redis    ‚îÇ
‚îÇ flush data      ‚îÇ 0.1s ‚úÖ ‚îÇ Staging  ‚îÇ
‚îÇ upload S3       ‚îÇ 0s ‚úÖ   ‚îÇ Delayed  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ò–¢–û–ì–û           ‚îÇ 20s     ‚îÇ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–£–∑–∫–æ–µ –º–µ—Å—Ç–æ: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Å—ë –µ—â—ë 1 RTT –Ω–∞ —Ñ–∞–π–ª!
```

---

## üöÄ –ü–æ—à–∞–≥–æ–≤—ã–π –ü–ª–∞–Ω

### –®–∞–≥ 1: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Unsafe Batch (1-2 –¥–Ω—è)

**–°–º. `.vscode/UNSAFE_BATCH_POC.md`**

**–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:**
1. `pkg/meta/rueidis_unsafe_batch.go` - –Ω–æ–≤—ã–π —Ñ–∞–π–ª (~200 —Å—Ç—Ä–æ–∫)
2. `pkg/meta/rueidis.go` - –¥–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ `unsafeBatchMode`

**–§—É–Ω–∫—Ü–∏–∏:**
```go
func (m *rueidisMeta) doMknodUnsafeBatch(...) syscall.Errno {
    // Pipeline –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    cmds := []rueidis.Completed{
        m.client.B().Set().Key(inodeKey).Value(...).Build(),
        m.client.B().Set().Key(parentKey).Value(...).Build(),
        m.client.B().Hset().Key(entryKey).FieldValue(name, ...).Build(),
        m.client.B().Incrby().Key(usedSpaceKey).Increment(...).Build(),
    }
    results := m.client.DoMulti(ctx, cmds...)
    return processResults(results)
}

func (m *rueidisMeta) doWriteUnsafeBatch(...) syscall.Errno {
    // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∑–∞–ø–∏—Å–∏ chunks
}
```

### –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Writeback

```bash
# 1. –°–æ–∑–¥–∞—Ç—å FS
juicefs format --storage file \
    "rueidis://localhost:6379/1?unsafe_batch=1&metaprime=1" \
    /tmp/jfs-test

# 2. –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –û–ë–û–ò–ú–ò —Ñ–ª–∞–≥–∞–º–∏
juicefs mount \
    --writeback \
    --upload-delay=10m \
    --buffer-size=2048 \
    --cache-size=102400 \
    --free-space-ratio=0.05 \
    rueidis://localhost:6379/1?unsafe_batch=1&metaprime=1 \
    /mnt/jfs

# 3. Benchmark
echo "=== Test 1: Create 10,000 files ==="
time bash -c 'for i in {1..10000}; do touch /mnt/jfs/file$i.txt; done'
# –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: 0.05-0.1 —Å–µ–∫—É–Ω–¥—ã (vs 20s –±–µ–∑ —É–ª—É—á—à–µ–Ω–∏–π)

echo "=== Test 2: Write 10,000 files ==="
time bash -c 'for i in {1..10000}; do echo "test data" > /mnt/jfs/file$i.txt; done'
# –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: 0.1-0.2 —Å–µ–∫—É–Ω–¥—ã

echo "=== Test 3: Delete 10,000 files ==="
time bash -c 'for i in {1..10000}; do rm /mnt/jfs/file$i.txt; done'
# –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: 0.05-0.1 —Å–µ–∫—É–Ω–¥—ã

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å staging
cat /mnt/jfs/.stats | grep staging
# juicefs_staging_blocks: 0 (–≤—Å—ë —É–∂–µ —É–¥–∞–ª–µ–Ω–æ)

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
ls -lh /mnt/jfs/
```

### –®–∞–≥ 3: –ò–∑–º–µ—Ä–µ–Ω–∏–µ –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:**

```bash
# Baseline (–±–µ–∑ —É–ª—É—á—à–µ–Ω–∏–π)
juicefs mount redis://localhost:6379/1 /mnt/baseline
time bash -c 'for i in {1..1000}; do touch /mnt/baseline/f$i; done'
# –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: 2-3 —Å–µ–∫—É–Ω–¥—ã

# –¢–æ–ª—å–∫–æ writeback
juicefs mount --writeback redis://localhost:6379/1 /mnt/writeback
time bash -c 'for i in {1..1000}; do touch /mnt/writeback/f$i; done'
# –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: 2-2.5 —Å–µ–∫—É–Ω–¥—ã (–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ)

# unsafe_batch + writeback
juicefs mount --writeback \
    rueidis://localhost:6379/1?unsafe_batch=1 /mnt/combo
time bash -c 'for i in {1..1000}; do touch /mnt/combo/f$i; done'
# –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: 0.01-0.02 —Å–µ–∫—É–Ω–¥—ã (100-200√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ!)
```

---

## üîç –ü–æ—á–µ–º—É –ù—É–∂–Ω—ã –û–±–∞ –£–ª—É—á—à–µ–Ω–∏—è

### –£–∑–∫–∏–µ –ú–µ—Å—Ç–∞ –≤ JuiceFS

```
–û–ø–µ—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç        ‚îÇ –í—Ä–µ–º—è   ‚îÇ –£–ª—É—á—à–µ–Ω–∏–µ          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. Metadata      ‚îÇ 1ms RTT ‚îÇ unsafe_batch ‚úÖ    ‚îÇ
‚îÇ    (doMknod)     ‚îÇ         ‚îÇ (500√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ)   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 2. Data buffer   ‚îÇ 0.01ms  ‚îÇ –£–∂–µ –±—ã—Å—Ç—Ä–æ         ‚îÇ
‚îÇ    (write)       ‚îÇ         ‚îÇ                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 3. Metadata      ‚îÇ 1ms RTT ‚îÇ unsafe_batch ‚úÖ    ‚îÇ
‚îÇ    (flush)       ‚îÇ         ‚îÇ (500√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ)   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 4. Data upload   ‚îÇ 10ms    ‚îÇ writeback ‚úÖ       ‚îÇ
‚îÇ    (S3)          ‚îÇ         ‚îÇ (100√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ë–µ–∑ —É–ª—É—á—à–µ–Ω–∏–π: 1ms + 0.01ms + 1ms + 10ms = 12ms –Ω–∞ —Ñ–∞–π–ª
–° unsafe_batch: 0.002ms + 0.01ms + 0.002ms + 10ms = 10ms
–° writeback: 1ms + 0.01ms + 1ms + 0.1ms = 2ms
–° –û–ë–û–ò–ú–ò: 0.002ms + 0.01ms + 0.002ms + 0.1ms = 0.1ms ‚úÖ

–£—Å–∫–æ—Ä–µ–Ω–∏–µ: 12ms / 0.1ms = 120√ó –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
           –î–ª—è 10,000 —Ñ–∞–π–ª–æ–≤: 20 —Å–µ–∫—É–Ω–¥ ‚Üí 0.15 —Å–µ–∫—É–Ω–¥ = 133√ó
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ó–∞–º–µ—á–∞–Ω–∏—è

### 1. Unsafe Batch - –¢–æ–ª—å–∫–æ –¥–ª—è –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –°—Ü–µ–Ω–∞—Ä–∏–µ–≤

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ:**
- ‚úÖ –û–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç –º–æ–Ω—Ç–∏—Ä—É–µ—Ç FS
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (build artifacts)
- ‚úÖ PoC / —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –í–∞—à —Å–ª—É—á–∞–π: "–Ø –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –¥–∏—Å–∫–µ –±—É–¥—É –æ–¥–∏–Ω"

**–û–ü–ê–°–ù–û:**
- ‚ùå –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚ùå Production workloads
- ‚ùå –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### 2. Writeback - –†–∏—Å–∫ –ü–æ—Ç–µ—Ä–∏ –î–∞–Ω–Ω—ã—Ö

**–†–∏—Å–∫–∏:**
- ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –≤ staging –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã –ø—Ä–∏ —Å–±–æ–µ –¥–∏—Å–∫–∞
- ‚ö†Ô∏è –î–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3 –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ

**–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSD —Å —Ö–æ—Ä–æ—à–µ–π –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å—é
- ‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `juicefs_staging_blocks`
- ‚úÖ –ù–µ —É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã –∏–∑ `/var/jfsCache/rawstaging/`
- ‚úÖ –ü—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `--wait` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤

### 3. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è = –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –†–∏—Å–∫

**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:**

```
unsafe_batch + writeback:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –†–∏—Å–∫ 1: Race conditions (unsafe_batch)        ‚îÇ
‚îÇ –†–∏—Å–∫ 2: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ (writeback)    ‚îÇ
‚îÇ                                                ‚îÇ
‚îÇ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: –û–ß–ï–ù–¨ –û–ü–ê–°–ù–û –¥–ª—è production!      ‚îÇ
‚îÇ                                                ‚îÇ
‚îÇ ‚úÖ OK –¥–ª—è:                                    ‚îÇ
‚îÇ    - –û–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç                              ‚îÇ
‚îÇ    - –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ                          ‚îÇ
‚îÇ    - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã                          ‚îÇ
‚îÇ    - Performance PoC                          ‚îÇ
‚îÇ                                                ‚îÇ
‚îÇ ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è:                       ‚îÇ
‚îÇ    - Production                               ‚îÇ
‚îÇ    - –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ                         ‚îÇ
‚îÇ    - –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù –ö—Ä–∞—Ç–∫–∏–π –û—Ç–≤–µ—Ç –Ω–∞ –í–∞—à –í–æ–ø—Ä–æ—Å

> `--upload-delay=10m` –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, —Ç.–∫. –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–ª–æ–∂–∏—Ç—å —Ñ–∞–π–ª –≤ –∫–µ—à –Ω—É–∂–Ω–æ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –µ–≥–æ –≤ –º–µ—Ç–µ, –∞ —Å —ç—Ç–∏–º –ø—Ä–æ–±–ª–µ–º—ã.

**–í—ã –ø—Ä–∞–≤—ã! –†–µ—à–µ–Ω–∏–µ:**

```bash
# –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –æ–±–æ–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π:
juicefs mount \
    --writeback \                          # –î–∞–Ω–Ω—ã–µ ‚Üí staging (–±—ã—Å—Ç—Ä–æ)
    --upload-delay=10m \                    # S3 upload –æ—Ç–ª–æ–∂–µ–Ω
    rueidis://localhost:6379/1?unsafe_batch=1 \  # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ ‚Üí batched
    /mnt/jfs

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: 500√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ (batching)
# - –î–∞–Ω–Ω—ã–µ: 100√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ (writeback)
# - –ö–æ–º–±–æ: 200-500√ó –¥–ª—è –º–µ–ª–∫–∏—Ö —Ñ–∞–π–ª–æ–≤!
```

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
```
10,000 —Ñ–∞–π–ª–æ–≤:
  –ë–ï–ó —É–ª—É—á—à–µ–Ω–∏–π: 30 —Å–µ–∫—É–Ω–¥
  + writeback: 20 —Å–µ–∫—É–Ω–¥ (1.5√ó) ‚ùå –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
  + unsafe_batch: 10 —Å–µ–∫—É–Ω–¥ (3√ó) ‚ö†Ô∏è –ª—É—á—à–µ
  + –û–ë–ê: 0.15 —Å–µ–∫—É–Ω–¥—ã (200√ó) ‚úÖ –û–¢–õ–ò–ß–ù–û!
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ –®–∞–≥–∏

1. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Unsafe Batch** (—Å–º. `.vscode/UNSAFE_BATCH_POC.md`)
   - ~200 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
   - 1-2 –¥–Ω—è —Ä–∞–±–æ—Ç—ã

2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å writeback**
   ```bash
   juicefs mount --writeback \
       rueidis://...?unsafe_batch=1 /mnt/jfs
   ```

3. **–ò–∑–º–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ**
   - –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤: –æ–∂–∏–¥–∞–µ–º 100-200√ó
   - –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö: –æ–∂–∏–¥–∞–µ–º 100-200√ó
   - –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤: –æ–∂–∏–¥–∞–µ–º 100-200√ó

4. **–ï—Å–ª–∏ PoC —É—Å–ø–µ—à–µ–Ω ‚Üí Lua Scripts**
   - –¢–∞ –∂–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   - –ù–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è production

---

**–°—Ç–∞—Ç—É—Å:** –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å Unsafe Batch PoC + Writeback  
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 200√ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–ª—è –º–µ–ª–∫–∏—Ö —Ñ–∞–π–ª–æ–≤  
**–î–∞—Ç–∞:** 2025-10-30
